os: linux
dist: xenial
language: python
python: 3.7
sudo: required
fast_finish: true

addons:
  apt:
    sources:
      - sourceline: 'ppa:ubuntugis/ppa'
    packages:
      - gdal-bin
      - geographiclib-tools
      - libfftw3-dev
      - libgdal-dev
      - libgeographic-dev
  homebrew:
    packages:
      # GDAL is already included on osx images
      - geographiclib
      - fftw

install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
        # Work in a virtual environment to avoid having to do
        # "pip3 install --user"
        python3 -m venv venv
        source venv/bin/activate
    fi
  - pip install -e .

script: pytest --cov=s2p --cov-report term-missing tests

jobs:
  include:
    - stage: packaging
      name: "Python sdist installation"
      install: skip
      script:
        - python setup.py sdist
        - pip install dist/*.tar.gz
    - stage: packaging
      name: "Docker build"
      addons: skip
      install: skip
      script: docker build .

    - stage: test
    - stage: test
      python: 2.7
    - stage: test
      os: osx
      # The default osx image (xcode9.4 as of 2019-09-30) has a very old brew,
      # which crashes with the `addons` feature, so we use a non-default more recent one
      # (see https://github.com/Homebrew/homebrew-bundle/issues/540#issuecomment-518301382)
      osx_image: xcode10.2
      language: generic

    - stage: deploy
      if: tag IS present AND repo = cmla/s2p
      install: skip
      script: skip
      deploy:
        - provider: pypi
          user: carlodef
          password:
            YOUR_PASSWORD_HERE
          distributions: sdist
          on:
            tags: true
